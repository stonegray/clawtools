# CI — runs on every push and PR to main and dev
#
# Jobs:
#   lint-typecheck  — tsc --noEmit (catches type errors fast, no output)
#   test            — vitest run with coverage (matrix: node 20, 22)
#   build           — full tsc build + verify dist/ is non-empty
#
# All three must pass before a PR can merge (enforce via branch protection rules).

name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # 1. Type checking (fastest gate — fails early on TS errors)
  # ---------------------------------------------------------------------------
  lint-typecheck:
    name: Type check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: TypeScript — check src/
        run: npx tsc --noEmit

      - name: TypeScript — check test/
        run: npx tsc --project tsconfig.test.json --noEmit

  # ---------------------------------------------------------------------------
  # 2. Tests with coverage (matrix across Node LTS versions)
  # ---------------------------------------------------------------------------
  test:
    name: Test (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    needs: lint-typecheck

    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - run: npm ci

      - name: Run tests
        run: npm run test:coverage

      - name: Upload coverage (Node 22 only)
        if: matrix.node == 22 && !env.ACT
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/
          retention-days: 14

  # ---------------------------------------------------------------------------
  # 3. Build — verify tsc produces a clean dist/
  # ---------------------------------------------------------------------------
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-typecheck

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: Build
        run: npm run build

      - name: Verify dist/ is non-empty
        run: |
          [ -d dist ] || { echo "dist/ not created"; exit 1; }
          [ "$(find dist -name '*.js' | wc -l)" -gt 0 ] || { echo "dist/ has no .js files"; exit 1; }
          echo "dist/ OK — $(find dist -name '*.js' | wc -l) .js files"

      - name: Upload dist artifact
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-node22
          path: dist/
          retention-days: 7
